name: Daily Health Check Assignment

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  assign-health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find and assign health-check issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Searching for unassigned health-check issues..."

          # Get all open issues with health-check label that are not assigned
          unassigned_issues=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "health-check" \
            --state open \
            --json number,title,assignees \
            --jq '.[] | select(.assignees | length == 0) | .number')

          # Count unassigned issues
          issue_count=$(echo "$unassigned_issues" | grep -c '^[0-9]' || echo 0)

          echo "ðŸ“Š Found $issue_count unassigned health-check issue(s)"

          if [ "$issue_count" -eq 0 ]; then
            echo "âœ… No unassigned health-check issues found. All done!"
            exit 0
          fi

          # Get the first unassigned issue
          issue_number=$(echo "$unassigned_issues" | head -n 1)

          echo "ðŸŽ¯ Assigning issue #$issue_number to @copilot..."

          # Assign the issue to copilot
          gh issue edit "$issue_number" \
            --repo "${{ github.repository }}" \
            --add-assignee "copilot"

          echo "âœ… Successfully assigned issue #$issue_number to @copilot"

          # Get issue title for summary
          issue_title=$(gh issue view "$issue_number" \
            --repo "${{ github.repository }}" \
            --json title \
            --jq '.title')

          echo "ðŸ“ Issue: $issue_title"

          # Show remaining unassigned issues
          remaining=$((issue_count - 1))
          if [ "$remaining" -gt 0 ]; then
            echo "ðŸ“‹ $remaining unassigned health-check issue(s) remaining"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Daily Health Check Assignment Summary" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Workflow completed successfully" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." \
            >> $GITHUB_STEP_SUMMARY
